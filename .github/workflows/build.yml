name: æ„å»ºé•œåƒ

on:
  workflow_dispatch:

env:
  IMAGE_NAME: sqblog
  DEFAULT_TAG: latest

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 3. ç™»å½•åˆ° GitHub Container Registry (ghcr.io)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 4. å‡†å¤‡ Docker æ ‡ç­¾ï¼ˆé»˜è®¤ä½¿ç”¨ latestï¼‰
        id: prepare-tags
        run: |
          # GHCR ä»“åº“å®Œæ•´è·¯å¾„
          GHCR_REPO="ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"

          # åªæ¨é€ latestï¼ˆä¸é¢å¤–é™„åŠ  sha æ ‡ç­¾ï¼‰
          FULL_TAGS="${GHCR_REPO}:${{ env.DEFAULT_TAG }}"

          echo "âœ… å‡†å¤‡çš„é•œåƒæ ‡ç­¾ï¼š$FULL_TAGS"
          echo "tags=$FULL_TAGS" >> $GITHUB_OUTPUT

      - name: 5. æ„å»ºå¹¶æ¨é€ AMD64 æ¶æ„é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.prepare-tags.outputs.tags }}
          build-args: |
            NEXT_PUBLIC_SITE_URL=${{ vars.NEXT_PUBLIC_SITE_URL || 'https://sqing33.dpdns.org' }}
          cache-from: type=gha,scope=latest
          cache-to: type=gha,mode=max,scope=latest

      - name: 6. è¾“å‡ºé•œåƒä¿¡æ¯ï¼ˆä¾¿äºæŸ¥çœ‹æ„å»ºç»“æœï¼‰
        run: |
          echo "ğŸ‰ æˆåŠŸæ„å»ºå¹¶æ¨é€é•œåƒï¼"
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾ï¼š${{ steps.prepare-tags.outputs.tags }}"
          echo "ğŸ—ï¸  æ¶æ„ï¼šlinux/amd64"
          echo "ğŸ“ ä»“åº“åœ°å€ï¼šghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          echo "ğŸ” æ‹‰å–å‘½ä»¤ï¼šdocker pull ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.DEFAULT_TAG }}"
